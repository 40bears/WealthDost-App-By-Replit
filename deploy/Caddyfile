{
	# Global options block
	# Set automatic HTTPS off for local testing; remove/comment for production
	# auto_https off
	log {
		output stdout
		level DEBUG
	}
}

:80 {
	try_files {path} /index.html

	# Serve files from this directory
	root * /usr/share/caddy/html/public

	# Global no-cache policy
    header Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"

	# Serve the index file when directories are accessed
	file_server {
		index index.html index.htm
	}

	# Rewrite to serve static files correctly
	@staticFiles {
		file
		path *.html *.htm *.css *.js *.json *.xml *.svg *.woff *.woff2 *.ttf *.eot *.otf *.ico *.bmp *.png *.jpg *.jpeg *.gif *.webp *.mp4 *.webm *.ogv *.mp3 *.wav *.flac *.aac
	}

	handle @staticFiles {
		header Cache-Control Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"
	}

	# Compress all eligible assets
	encode zstd gzip

	# Handle requests with "api" prefix
	@api {
		path /api/*
	}
	handle @api {
		respond "API Service unavailable" 503
		header Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"
	}

	# Custom error pages
	handle_errors {
		@404 {
			expression {http.error.status_code} == 404
		}
		handle @404 {
			rewrite * /index.html
			file_server
			header Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"
		}
	}

	# MIME type-specific caching policies
	@css {
		path *.css
	}
	header @css Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"

	@javascript {
		path *.js
	}
	header @javascript Cache-Control Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"

	@imageFiles {
		path *.ico *.png *.jpg *.jpeg *.gif *.webp *.svg *.bmp
	}
	header @imageFiles Cache-Control Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"

	@mediaFiles {
		path *.mp4 *.webm *.ogv *.mp3 *.wav *.flac *.aac
	}
	header @mediaFiles Cache-Control Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"

	@html {
		path *.html
	}
	header @html Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"

	@apiResponses {
		path *.json *.xml *.rdf
	}
	header @apiResponses Cache-Control "no-store, no-cache, must-validate, proxy-revalidate, max-age=0"
}
